<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="">
  <meta name="author" content="">
  <title>School Profile</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
  <link href="../style/main.css" rel="stylesheet">
  <script src="//d3js.org/d3.v3.min.js"></script>
  <script src="../js/pdf.js"></script>
  <script src="../js/load-schools.js"></script>
  <script src="../js/demographics.js"></script>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->

  <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->

  <script>
    function images (ulcs) {
      d3.json('../data/image/' + ulcs + '/images.json', function (err, images) {
        if (err || !images) {
          return
        }
        d3.select('.images')
          .selectAll('.image')
          .data(images)
          .enter()
            .append('div')
              .attr('class', 'col-sm-3 col-xs-6 image')
              .append('a')
                .attr('href', function (d) {
                  return '../data/image/' + ulcs + '/' + d
                })
                .append('img')
                  .attr('class', 'img-responsive')
                  .attr('src', function (d) {
                    return '../data/image/' + ulcs + '/' + d
                  })
      })
    }

    function lead (ulcs, school) {
      var container = d3.select('.lead').select('.data')
      d3.json('../data/lead/' + ulcs + '/pdfs.json', function (err, pdfs) {
        if (pdfs) {
          ;(pdfs.results || []).forEach(function (p) {
            pdfPreview('../data/lead/' + ulcs + '/' + p, d3.select('.lead-reports'))
          })
          if (pdfs.letter) {
            pdfPreview('../data/lead/' + ulcs + '/' + pdfs.letter, d3.select('.lead-reports'))
          }
        }
        if (school.lead) {
          container.select('table tbody')
                   .selectAll('tr')
                   .data(school.lead)
                   .enter()
                   .append('tr')
                   .selectAll('td')
                   .data(function (d) {
                     return [d.datesampled,
                             d.numberbelowtheaaof15ppb,
                             d['numberelevated-aaof15ppb'],
                             d.numberofoutletstested,
                             d.totalofsamplescollected]
                   })
                   .enter()
                   .append('td')
                   .html(String)

        } else {
         container.html('Lead data not available')
        }
      })
    }

    function pdfPreview (file, container) {
      PDFJS.getDocument(file).then(function (pdf) {
        function handlePage (page) {
          var viewport = page.getViewport(.5)
            , canvas = document.createElement('canvas')
            , context = canvas.getContext('2d')

          canvas.style.display = 'block'
          canvas.height = viewport.height
          canvas.width = viewport.width

          page.render({canvasContext: context, viewport: viewport})
              .then(function () {
                //context.fillRect( 0, 0, canvas.width, canvas.height )
                //context.globalCompositeOperation = 'destination-over'
                //context.fillStyle = '#fff'
                //context.fillRect(0, 0, canvas.width, canvas.height)

                container
                  .append('div')
                    .attr('class', 'col-sm-3 col-xs-6')
                    .append('a')
                      .attr('href', file)
                      .append('img')
                      .attr('class', 'img-responsive')
                      .attr('src', canvas.toDataURL())
              })
        }
        pdf.getPage(1).then(handlePage)
      }, function (err) {
        // No reports
      })
    }

    function reports (ulcs) {
      pdfPreview('../data/pdf/report/' + ulcs + '.pdf', d3.select('.reports'))
    }

    function demographics (data) {
      var width = 700
        , height = 400
        , radius = Math.min(width, height) / 2
        , labelR = radius + 10 * 2
        , color = d3.scale.ordinal()
                          .range(['#7dc61e', '#a9a10a', '#d17813', '#e85434', '#e73a62'])
        , arc = d3.svg.arc()
                      .outerRadius(radius - 10)
                      .innerRadius(0)
        , labelArc = d3.svg.arc()
                           .outerRadius(radius - 40)
                           .innerRadius(radius - 40)

      var pie = d3.layout.pie()
                         .sort(null)
                         .value(function (d) {
                           return d[1]
                         })

      var svg = d3.select('.demographics-chart')
                  .append('svg')
                    .attr('width', width)
                    .attr('height', height)
                    .append('g')
                      .attr('transform', 'translate(' + (width / 2 + 20) + ',' + height / 2 + ')')
        , g = svg.selectAll('.arc')
                 .data(pie(data))
                 .enter()
                 .append('g')
                   .attr('class', 'arc')

        g.append('path')
           .attr('d', arc)
           .style('fill', function (d) {
             return color(d.data[1])
           })

        g.append('text')
           .attr('transform', function (d) {
             var c = arc.centroid(d)
               , x = c[0]
               , y = c[1],

             h = Math.sqrt(x*x + y*y)
             return 'translate(' + (x / h * labelR) + ',' + (y / h * labelR) + ')'
           })
           .attr('text-anchor', function (d) {
             return (d.endAngle + d.startAngle)/2 > Math.PI ? 'end' : 'start'
           })
           .attr('dy', '.35em')
           .text(function (d) {
             return d.data[0] + ' (' + d.data[2] + ')'
           })
    }

    document.addEventListener('DOMContentLoaded', function(event) {
      var url = window.location.href
        , regex = /[?&]ulcs(=([^&#]*)|&|#|$)/
        , results = regex.exec(url)

      if (!results || !results[2]) {
        document.querySelector('.container').innerHTML = 'No School Data Found'
      } else {
        var ulcs = decodeURIComponent(results[2].replace(/\+/g, ' '))
        loadSchools(function (err, schools) {
          var school = schools.filter(function (s) { return s.ulcscode == ulcs })[0]
          if (school) {
            d3.select('.school-name').text(school.schoolnameulcs)
            d3.select('.region').text(school.planningarea)
            d3.select('.address').text(school.streetaddress)
            d3.select('.level').text(school.schooltype)
            d3.select('.councilmanic').text(school.councilmanicdistrictrep)
            d3.select('.principal').text(school.principal)

            d3.select('.cac').text(school.conditionassessmentcostcac)
            d3.select('.replacement-cost').text(school.replacementcostcrv)
            d3.select('.fci').text(d3.format('%')(school.facilityconditionindexfci))

            demographics(demographicsData(school))
            reports(ulcs)
            images(ulcs)
            lead(ulcs, school)
          }
        })

      }
    })
  </script>

</head>
<body>

  <!-- Navigation -->
  <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <input type="checkbox" id="navbar-toggle-cbox">
      <div class="navbar-header">
        <label for="navbar-toggle-cbox" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </label>
        <a class="navbar-brand" href="http://www.healthyschoolbuildings.com/">Healthy School Buildings</a>
      </div>

      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="nav navbar-nav">
          <li>
            <a href="../general.html">General</a>
          </li>
          <li>
            <a href="../">Map</a>
          </li>
          <li>
            <a href="./">Lead Testing</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="row">
      <div class="col-lg-12">
        <h1 class="page-header"><span class="school-name"></span>
          <br /><small>Profile</small>
        </h1>
      </div>
    </div>

    <div class="row">
      <div class="col-md-4">
        <h3>School Details</h3>
        <dl>
          <dt>Region</dt>
          <dd class="region"></dd>
          <dt>Address</dt>
          <dd class="address"></dd>
          <dt>Level</dt>
          <dd class="level"></dd>
          <dt>Councilmanic</dt>
          <dd class="councilmanic"></dd>
          <dt>Principal</dt>
          <dd class="principal"></dd>
        </dl>
        <hr />
        <h4>Facilities Condition Index (FCI)
          <small>** Preliminary CA and FCI calculations. Values subject to change.</small>
        </h4>
        <dl>
          <dt>Conditions Assessment Cost</dt>
          <dd class="cac"></dd>
          <dt>Replacement Cost</dt>
          <dd class="replacement-cost"></dd>
          <dt>Facilities Condition Index</dt>
          <dd class="fci"></dd>
        </dl>
      </div>

      <div class="col-md-8">
        <h3>Demographics</h3>
        <div class="demographics-chart"></div>
      </div>
    </div>

    <div class="row lead">
      <div class="col-lg-12">
        <h3 class="page-header">Lead Data</h3>
        <div class="data">
          <table class="table table-striped">
            <thead>
              <tr>
                <th>Sample Date</th>
                <th>Below 15 ppb</th>
                <th>Above 15 ppb</th>
                <th>Outlets tested</th>
                <th>Samples Collected</th>
              </tr>
            </thead>
            <tbody>
            </tbody>
          </table>
        </div>
        <div>
          <h4>Letters and sampling results (PDFs)</h4>
          <div class="lead-reports">

          </div>
        </div>

      </div>
    </div>


    <div class="row images">
      <div class="col-lg-12">
        <h3 class="page-header">Images
          <small>View images collected showing conditions at this school</small>
        </h3>
      </div>
    </div>

    <div class="row reports">
      <div class="col-lg-12">
        <h3 class="page-header">Reports
        </h3>
      </div>
    </div>

    <div class="row">
      <div class="col-lg-12">
        <h3 class="page-header">Other Relevant Information
          <small>Articles, videos, newspaper reports, etc.</small>
        </h3>
      </div>
      <ul>
        <li><a href="#">Example One</a></li>
        <li><a href="#">Example Two</a></li>
        <li><a href="#">Example Three</a></li>
        <li><a href="#">Example Four</a></li>
      </ul>
    </div>

    <hr>

    <footer>
      <div class="row">
        <div class="col-lg-12">
          <p>Copyright &copy; Healthy School Buildings 2016</p>
        </div>
      </div>
    </footer>

  </div>
</body>

</html>
