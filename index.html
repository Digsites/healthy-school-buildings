<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Healthy School Buildings</title>
  <script src="//d3js.org/d3.v3.min.js"></script>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
  <!--[if lte IE 8]>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
  <![endif]-->
  <!--[if gt IE 8]><!-->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
  <!--<![endif]-->
  <style type="text/css">

    .neighborhoods path {
      stroke: #fff;
      stroke-width: .5px;
      stroke-opacity: .5;
      fill: #81abce;
    }

    .column {
      max-width: 960px;
      position: relative;
      display: block;
      margin: 0 auto;
      padding: 0 10px;
    }

    circle.school {
      fill: #ff6600;
      fill-opacity: .6;
      stroke: #fff;
    }

    circle.school.active {
      fill: #fbcc3c;
      stroke-width: 1px;
    }

    svg {
      border: solid 1px #eee;
      border-bottom: solid 1px #ccc;
    }

    .background {
      fill: none;
      pointer-events: all;
    }

    div.help {
      text-align: right;
    }

    label, span {
      font-size: 18px;
    }

    .hide {
      display: none;
    }

    #details {
      padding-top: 20px;
    }

    #details label {
      font-weight: bold;
    }

    #details span {
      color: #737373;
    }

    #details div.field {
      padding-top: 10px;
    }

    legend.school {
      font-size: 36px;
    }

  </style>
</head>
<body>
  <div class="column">
    <div id="map"></div>
    <div class="help">
      * Click on a bubble for school details.
    </div>

    <form id="details" class="hide pure-form pure-form-stacked">
      <fieldset>
        <legend class="school"></legend>

        <div class="pure-g">
          <div class="pure-u-1 pure-u-md-2-3">
            <fieldset>
              <div class="address field">
                <label>Address</label>
                <span id="street"></span><br/>
                <span id="location"></span>
              </div>

              <div class="pure-control-group field">
                <label for="year">Year Built</label>
                <span id="year"></span>
              </div>

              <div class="pure-control-group field">
                <label for="councilmanic">Councilmanic District &amp; Rep</label>
                <span id="councilmanic"></span>
              </div>
            </fieldset>
          </div>

          <div class="pure-u-1 pure-u-md-1-3">
            <div class="pure-form pure-form-aligned">
              <fieldset>
                <div class="pure-control-group field">
                  <label for="ulcs">ULCS Code</label>
                  <span id="ulcs"></span>
                </div>

                <div class="pure-control-group field">
                  <label for="total-students">Total # of Students</label>
                  <span id="total-students"></span>
                </div>

                <div class="pure-control-group field">
                  <label for="fci">Facility Condition Index (FCI) %</label>
                  <span id="fci"></span>
                </div>

                <div class="pure-control-group field">
                  <label for="cac">Condition Assessment Cost (CAC) in Millions</label>
                  <span id="cac"></span>
                </div>
              </fieldset>
            </div>
          </div>
        </div>
      </fieldset>
    </form>
  </div>
</body>
<script>

  function details (selection) {
    selection.each(function (data) {
      var d = d3.select(this)
                .classed('hide', false)

      d.select('legend')
       .text(function (d) {
        return d.schoolnameulcs + ' (' + d.schooltype + ')'
      })

      d.select('.address #street')
       .text(function (d) { return d.streetaddress })

      d.select('.address #location')
       .text(function (d) { return d.city + ', ' + d.state  + ' ' + d.zipcode })

      d.select('#year')
       .text(function (d) { return d.yearbuilt })

      d.select('#councilmanic')
       .text(function (d) { return d.councilmanicdistrictrep })

      d.select('#ulcs')
       .text(function (d) { return d.ulcscode })

      d.select('#total-students')
       .text(function (d) { return d.totalofstudents })

      d.select('#fci')
       .text(function (d) { return d3.format('%')(d['facilityconditionindexfci-']) })

      d.select('#cac')
       .text(function (d) { return d3.format('$')(d['conditionassessmentcostcac-inmillionsof']) })

    })
  }

  function fetch (next) {
    var url = 'https://spreadsheets.google.com/feeds/list/13lKZiT0nbnswab36cBlV37_Wb6ppikbHwzcx14Rvkog/default/public/values?alt=json'
    d3.json(url, function (err, response) {
      if (err) {
        return next(err)
      }
      next(null, response.feed.entry.map(function (entry) {
        return Object.keys(entry).reduce(function (p, c) {
          if (c.indexOf('gsx$') === 0) {
            p[c.slice(4)] = entry[c].$t
          }
          return p
        }, {})
      }))
    })
  }

  function centroid (d) {
    return 'translate(' + path.centroid({
      type: 'Feature',
      geometry: {
        coordinates: d.coordinates.split(','),
        type: 'Point'
      }
    }) + ')'
  }

  var width = 960
    , height = 600
    , map = d3.select('#map')
                .append('svg')
                  .style('width', width)
                  .style('height', height)
                  .append('g')
    , schools = map.selectAll('circle.school')
    , projection = d3.geo.albers()
                         .scale(1)
                         .translate([0, 0])
    , path = d3.geo.path()
                  .projection(projection)
    , zoom = d3.behavior.zoom()
                        .on('zoom', function  () {
                          projection.translate(d3.event.translate)
                                    .scale(d3.event.scale)

                          map.selectAll('path').attr('d', path)
                          schools.attr('transform', centroid)
                        })

  // draw philly
  d3.json('data/philly.geo.json', function (json) {
    var b = path.bounds(json)
      , s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height)
      , t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2]

    projection.scale(s)
              .translate(t)
    zoom.translate(projection.translate())
        .scale(projection.scale())

    map.call(zoom)

    map.append('rect')
        .attr('class', 'background')
        .attr('width', width)
        .attr('height', height)

    map.append('g')
         .attr('class', 'neighborhoods')
         .selectAll('path')
           .data(json.features)
           .enter()
           .append('path')
             .attr('d', path)

    fetch(function (err, _schools) {
      var heatmap = d3.scale.threshold()
                            .domain([.2, .4, .6])
                            .range(['green', 'yellow', 'red', 'red'])

      schools = schools.data(_schools)
      schools.enter()
             .append('circle')
               .attr('class', 'school')
               .attr('r', function (d) {
                 return d.totalofstudents / 100
               })
               .style('fill', function (d) {
                 return heatmap(d['facilityconditionindexfci-'])
               })
               .attr('transform', centroid)
               .on('click', function (d) {
                 schools.classed('active', false)
                 d3.select(this)
                   .classed('active', true)

                 d3.select('#details')
                   .datum(d)
                   .call(details)
               })
               .append('title').text(function (d) { return d.schoolnameulcs})
    })
  })

</script>
