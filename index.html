<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Healthy School Buildings</title>
  <script src="//d3js.org/d3.v3.min.js"></script>
  <script src="js/sifter.min.js"></script>
  <script src="js/d3-tip.js"></script>
  <style type="text/css">

    /* Tooltip Style */
    .d3-tip {
      line-height: 1;
      font-weight: bold;
      padding: 12px;
      background: rgba(0, 0, 0, 0.6);
      color: #fff;
      border-radius: 2px;
      pointer-events: none;
    }

    /* Creates a small triangle extender for the tooltip */
    .d3-tip:after {
      box-sizing: border-box;
      display: inline;
      font-size: 10px;
      width: 100%;
      line-height: 1;
      color: rgba(0, 0, 0, 0.8);
      position: absolute;
      pointer-events: none;
    }

    /* Northward tooltips */
    .d3-tip.n:after {
      content: "\25BC";
      margin: -1px 0 0 0;
      top: 100%;
      left: 0;
      text-align: center;
    }

    /* Eastward tooltips */
    .d3-tip.e:after {
      content: "\25C0";
      margin: -4px 0 0 0;
      top: 50%;
      left: -8px;
    }

    /* Southward tooltips */
    .d3-tip.s:after {
      content: "\25B2";
      margin: 0 0 1px 0;
      top: -8px;
      left: 0;
      text-align: center;
    }

    /* Westward tooltips */
    .d3-tip.w:after {
      content: "\25B6";
      margin: -4px 0 0 -1px;
      top: 50%;
      left: 100%;
    }

    .neighborhoods path {
      stroke: #fff;
      stroke-width: .5px;
      stroke-opacity: .5;
      fill: #81abce;
    }

    .container {
      max-width: 960px;
      position: relative;
      display: block;
      margin: 0 auto;
      padding: 0 10px;
    }

    circle.school {
      fill: #ff6600;
      stroke: #fff;
    }

    circle.school.active {
      fill: #fbcc3c;
      stroke-width: 1px;
    }

    svg {
      border: solid 1px #eee;
      border-bottom: solid 1px #ccc;
    }

    .background {
      fill: none;
      pointer-events: all;
    }

    div.help {
      text-align: right;
    }

    div.column {
      width: 50%;
    }

    div.column.left {
      float: left;
    }

    div.column.right {
      float: right;
    }

    div.column .field {
      padding-top: 10px;
    }

    div.column.right .field span {
      float: right;
    }

    .hide {
      display: none;
    }

    .buttons {
      position: absolute;
      left: 20px;
      top: 40px;
    }

    .slider {
      position: absolute;
      right: 0;
      margin-right: 10px;
      top: 40px;
    }

    .search {
      margin: 20px;
    }

    .search input {
      width: 200px;
    }

    .slider label {
      display: block;
    }

    .help div {
      padding: 2px;
    }

  </style>
</head>
<body>
  <div class="container">
    <div class="buttons">
      <button data-zoom="+1">Zoom In</button>
      <button data-zoom="-1">Zoom Out</button>
    </div>
    <div class="search">
      <label for="search">Search</label>
      <input type="text" id="search" />
    </div>
    <div class="slider">
      <div class="min">
        <label>Min FCI (<span id="min-fci-output">0%</span>)</label>
        <input type="range" id="min-fci" min="0" max="100" value="0">
      </div>
      <div class="max">
        <label>Max FCI (<span id="max-fci-output">100%</span>)</label>
        <input type="range" id="max-fci" min="0" max="100" value="100">
      </div>
    </div>

    <div id="map"></div>
    <div class="help">
      <div>
        * Click on a bubble for school details.
      </div>
      <div>
        ** Bubble size reflects school student population as of the 2015-2016 school year.
      </div>
      <div>
        *** The bubble color is related to the <em>“Facility Condition Index” [FCI]</em> which is a measure of school building
            condition by relating the school’s <em>“Condition Assessment Cost” [CAC]</em>, the amount in millions of $$
            required to adequately fix the school in relationship to the amount of $$ that would be required to replace the school.   <br />

      </div>
    </div>

    <form id="details" class="hide details">
      <fieldset>
        <legend class="school"></legend>
        <div class="column left">
          <div class="address field">
            <label>Address</label><br />
            <span id="street"></span><br/>
            <span id="location"></span>
          </div>

          <div class="field">
            <label for="year">Year Built</label>
            <span id="year"></span>
          </div>

          <div class="field">
            <span id="councilmanic"></span>
          </div>
        </div>

        <div class="column right">
          <div class="field">
            <label for="ulcs">ULCS Code</label>
            <span id="ulcs"></span>
          </div>

          <div class="field">
            <label for="total-students">Total # of Students</label>
            <span id="total-students"></span>
          </div>

          <div class="field">
            <label for="fci">Facility Condition Index (FCI) %</label>
            <span id="fci"></span>
          </div>

          <div class="field">
            <label for="cac">CAC (in Millions)</label>
            <span id="cac"></span>
          </div>
        </div>

      </fieldset>
    </form>
  </div>
</body>
<script>

  function details (data) {
    var d = d3.select('#details')
              .datum(data)

    d.select('legend')
     .text(function (d) {
      return d.schoolnameulcs + ' (' + d.schooltype + ')'
    })

    d.select('.address #street')
     .text(function (d) { return d.streetaddress })

    d.select('.address #location')
     .text(function (d) { return d.city + ', ' + d.state  + ' ' + d.zipcode })

    d.select('#year')
     .text(function (d) { return d.yearbuilt })

    d.select('#councilmanic')
     .text(function (d) { return d.councilmanicdistrictrep })

    d.select('#ulcs')
     .text(function (d) { return d.ulcscode })

    d.select('#total-students')
     .text(function (d) { return d.totalofstudents })

    d.select('#fci')
     .text(function (d) {
      var fci = d['facilityconditionindexfci-']
      if (fci === 'UNKNOWN') {
        return fci
      }
      return d3.format('%')(fci)
    })

    d.select('#cac')
     .text(function (d) { return d3.format('$')(d['conditionassessmentcostcac-inmillionsof']) })

    return d.html()
  }

  function fetch (next) {
    var url = 'https://spreadsheets.google.com/feeds/list/13lKZiT0nbnswab36cBlV37_Wb6ppikbHwzcx14Rvkog/default/public/values?alt=json'
    d3.json(url, function (err, response) {
      if (err) {
        return next(err)
      }
      next(null, response.feed.entry.map(function (entry) {
        return Object.keys(entry).reduce(function (p, c) {
          if (c.indexOf('gsx$') === 0) {
            p[c.slice(4)] = entry[c].$t
          }
          return p
        }, {})
      }))
    })
  }

  function filterSchools () {
    var min = document.querySelector('#min-fci').value / 100
      , max = document.querySelector('#max-fci').value / 100
      , term = document.querySelector('#search').value.trim()
      , sifted = sifter.search(term, {
                         fields: ['schoolnameulcs', '_schoolnameulcs', 'ulcs', 'streetaddress', 'zipcode']
                       })
                       .items
                       .map(function (r) {
                         return r.id
                       })

    schools.style('display', '')
           .filter(function (d, i) {
             var fci = d['facilityconditionindexfci-']
               , hidden = fci < min || fci >= max //|| fci == 'UNKNOWN'

             if (hidden) {
               return true
             }

             return sifted.indexOf(i) === -1
           })
           .style('display', 'none')
  }

  function centroid (d) {
    return path.centroid({
      type: 'Feature',
      geometry: {
        coordinates: d.coordinates.split(','),
        type: 'Point'
      }
    })
  }

  function transform (d) {
    return 'translate(' + centroid(d) + ')'
  }

  // Handle the slider
  d3.select('#min-fci')
    .on('input', function () {
      d3.select('#min-fci-output').text(this.value + '%')
      filterSchools()
    })

  d3.select('#max-fci')
    .on('input', function () {
      d3.select('#max-fci-output').text(this.value + '%')
      filterSchools()
    })

  d3.select('#search')
    .on('keyup', function () {
      filterSchools()
    })

  var width = 1024
    , height = window.outerHeight - 240
    , tip = d3.tip()
              .attr('class', 'd3-tip')
              .html(function (d) {
                return details(d)
              })
    , map = d3.select('#map')
                .append('svg')
                  .style('width', width)
                  .style('height', height)
                  .append('g')
    , schools = map.selectAll('circle.school')
    , projection = d3.geo.albers()
                         .scale(1)
                         .translate([0, 0])
    , path = d3.geo.path()
                  .projection(projection)
    , zoom = d3.behavior.zoom()
                        .on('zoom', function  () {
                          projection.translate(d3.event.translate)
                                    .scale(d3.event.scale)

                          map.selectAll('path').attr('d', path)
                          schools.attr('transform', transform)
                        })
    , sifter

  map.call(tip)

  // draw philly
  d3.json('data/philly.geo.json', function (json) {
    var b = path.bounds(json)
      , s = .95 / Math.max((b[1][0] - b[0][0]) / width, (b[1][1] - b[0][1]) / height)
      , t = [(width - s * (b[1][0] + b[0][0])) / 2, (height - s * (b[1][1] + b[0][1])) / 2]

    projection.scale(s)
              .translate(t)
    zoom.translate(projection.translate())
        .scale(projection.scale())

    map.call(zoom)

    map.append('rect')
        .attr('class', 'background')
        .attr('width', width)
        .attr('height', height)

    map.append('g')
         .attr('class', 'neighborhoods')
         .selectAll('path')
           .data(json.features)
           .enter()
           .append('path')
             .attr('d', path)

    d3.selectAll('button[data-zoom]')
      .on('click', function () {
        map.call(zoom.event)
        d3.event.preventDefault()

        var direction = +this.getAttribute('data-zoom')
          , target = zoom.scale() * (1 + .3 * direction)
          , current = 1
          , center = [width / 2, height / 2]
          , extent = zoom.scaleExtent()
          , translate = zoom.translate()
          , translate0 = []
          , l = []
          , view = {x: translate[0], y: translate[1], k: zoom.scale()}

        if (target < extent[0] || target > extent[1]) {
          return false
        }

        translate0 = [(center[0] - view.x) / view.k, (center[1] - view.y) / view.k]
        view.k = target

        l = [translate0[0] * view.k + view.x, translate0[1] * view.k + view.y]

        view.x += center[0] - l[0]
        view.y += center[1] - l[1]

        zoom.scale(view.k)
            .translate([view.x, view.y])

        map.transition().duration(350).call(zoom.event)
      })

    fetch(function (err, _schools) {
      var heatmap = d3.scale.threshold()
                            .domain([.2, .4, .6, .8])
                            .range(['#7dc61e', '#a9a10a', '#d17813', '#e85434', '#e73a62'])
        , size = d3.scale.linear()
                         .domain(d3.extent(_schools, function (d) {
                           return parseInt(d.totalofstudents, 10)
                         }))
                         .range([5, 15])

      sifter = new Sifter(_schools.map(function (_school) {
        _school._schoolnameulcs = _school.schoolnameulcs.replace(/\s/g, '')
        return _school
      }))

      schools = schools.data(_schools)
      schools.enter()
             .append('circle')
               .attr('class', 'school')
               .attr('r', function (d) {
                 return size(d.totalofstudents)
               })
               .style('fill', function (d) {
                 return heatmap(d['facilityconditionindexfci-'])
               })
               .attr('transform', transform)
               .on('mouseover', function (d) {
                 tip.direction('s')
                 // var c = centroid(d)
                 // if (c[1] < height / 2) {
                 //   tip.direction('s')
                 // } else {
                 //   tip.direction(c[0] < width / 2 ? 'e' : 'w')
                 // }
                 return tip.show.apply(this, arguments)
               })
               .on('mouseout', tip.hide)
               .on('click', function (d) {
                 window.open('school/index.html?ulcs=' + d.ulcscode + '', '_self', false)
               })
    })
  })

</script>
